@model ParentDashboardViewModel
@{
    ViewData["Title"] = "Tableau de bord Parent";

    string FormatPoints(int value) => value switch
    {
        > 0 => $"+{value}",
        < 0 => value.ToString(),
        _ => "0"
    };

    string FormatWeeklyChange(int value) => value switch
    {
        > 0 => $"+{value} cette semaine",
        < 0 => $"{value} cette semaine",
        _ => "Aucun changement cette semaine"
    };

    PointEntryType EffectiveType(RecentPointEntryItem entry) => entry.IsReset ? PointEntryType.Reset : entry.Type;

    string StatusLabel(RecentPointEntryItem entry) => entry switch
    {
        _ when EffectiveType(entry) == PointEntryType.Reset => "Reset",
        { IsActive: true } => "Actif",
        _ => "Archivé"
    };

    string StatusBadgeClass(RecentPointEntryItem entry) => entry switch
    {
        _ when EffectiveType(entry) == PointEntryType.Reset => "badge bg-secondary",
        { IsActive: true } => "badge bg-success",
        _ => "badge bg-secondary"
    };

    string TypeLabel(RecentPointEntryItem entry) => EffectiveType(entry) switch
    {
        PointEntryType.GoodPoint => "Bon point",
        PointEntryType.BadPoint => "Mauvais point",
        PointEntryType.Reward => "Récompense",
        PointEntryType.Bonus => "Bonus",
        PointEntryType.Reset => "Reset",
        _ => "Autre"
    };

    string TypeBadgeClass(RecentPointEntryItem entry) => EffectiveType(entry) switch
    {
        PointEntryType.GoodPoint => "badge bg-success-subtle text-success",
        PointEntryType.BadPoint => "badge bg-danger-subtle text-danger",
        PointEntryType.Reward => "badge bg-warning-subtle text-warning",
        PointEntryType.Bonus => "badge bg-info-subtle text-info",
        PointEntryType.Reset => "badge bg-secondary-subtle text-secondary",
        _ => "badge bg-light text-body border"
    };

    string PointsBadgeClass(RecentPointEntryItem entry) => EffectiveType(entry) switch
    {
        PointEntryType.BadPoint or PointEntryType.Reward => "badge bg-danger-subtle text-danger",
        PointEntryType.Bonus => "badge bg-info-subtle text-info",
        PointEntryType.Reset => "badge bg-secondary-subtle text-secondary",
        _ => entry.Points > 0 ? "badge bg-success-subtle text-success" : "badge bg-secondary-subtle text-secondary"
    };
}

<div class="container py-4">
    <div class="d-flex align-items-center mb-4">
        <div>
            <p class="text-muted mb-1">Vue d'ensemble familiale</p>
            <h1 class="h3 mb-0">Tableau de bord</h1>
        </div>
        <div class="ms-auto d-flex gap-2">
            <a class="btn btn-outline-primary" href="#">Exporter</a>
            <a class="btn btn-primary" asp-controller="ParentPoints" asp-action="AddPoints">Ajouter des points</a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <p class="text-muted mb-1">Total net</p>
                    <h4 class="fw-semibold">@FormatPoints(Model.Stats.Net)</h4>
                    <small class="text-success">@FormatWeeklyChange(Model.Stats.WeeklyNet)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <p class="text-muted mb-1">Points positifs</p>
                    <h4 class="fw-semibold text-success">@FormatPoints(Model.Stats.Plus)</h4>
                    <small class="text-muted">Récompenses méritées</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <p class="text-muted mb-1">Points négatifs</p>
                    <h4 class="fw-semibold text-danger">@(Model.Stats.Minus == 0 ? "0" : $"-{Model.Stats.Minus}")</h4>
                    <small class="text-muted">À suivre de près</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <p class="text-muted mb-1">Enfants suivis</p>
                    <h4 class="fw-semibold">@Model.Children.Count</h4>
                    <div class="d-flex gap-1 mt-2 flex-wrap">
                        @if (!Model.Children.Any())
                        {
                            <span class="text-muted small">Aucun enfant actif</span>
                        }
                        else
                        {
                            foreach (var child in Model.Children)
                            {
                                <span class="badge bg-light text-body border">@child.DisplayName</span>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 d-flex align-items-center">
                    <div>
                        <p class="text-muted mb-1">Historique</p>
                        <h5 class="mb-0">Dernières activités</h5>
                    </div>
                    <div class="ms-auto">
                        <a class="btn btn-sm btn-outline-secondary" href="/Parent/ChildDetails">Voir tout</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (!Model.RecentEntries.Any())
                    {
                        <div class="p-4 text-center text-muted">Aucune activité récente à afficher.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Enfant</th>
                                        <th>Motif</th>
                                        <th>Type</th>
                                        <th>Points</th>
                                        <th>Date</th>
                                        <th class="text-end">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var entry in Model.RecentEntries)
                                    {
                                        <tr>
                                            <td class="fw-semibold">@entry.ChildDisplayName</td>
                                            <td>@entry.Reason</td>
                                            <td><span class="@TypeBadgeClass(entry)">@TypeLabel(entry)</span></td>
                                            <td><span class="@PointsBadgeClass(entry)">@FormatPoints(entry.Points)</span></td>
                                            <td>@entry.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy")</td>
                                            <td class="text-end"><span class="@StatusBadgeClass(entry)">@StatusLabel(entry)</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
                <div class="card-footer bg-white border-0 text-end">
                    <button class="btn btn-outline-primary btn-sm">Exporter l'historique</button>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 d-flex align-items-center">
                    <div>
                        <p class="text-muted mb-1">Actions rapides</p>
                        <h5 class="mb-0">Gestion immédiate</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a class="btn btn-primary" asp-controller="ParentPoints" asp-action="AddPoints">Ajouter des points</a>
                        <a class="btn btn-outline-primary" href="/Parent/ChildDetails">Consulter un enfant</a>
                        <a class="btn btn-outline-secondary" href="/Parent/Settings">Ouvrir les réglages</a>
                        <form asp-action="ResetAllChildren" method="post" class="d-grid">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-danger"
                                    onclick="return confirm('Créer une ligne de reset pour tous les enfants ?');">
                                Reset des compteurs
                            </button>
                        </form>
                    </div>
                    <div class="mt-3 small text-muted">
                        Astuce : vous pouvez proposer un flux AJAX simple pour valider les lignes sans recharger la page.
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <p class="text-muted mb-1">Alertes</p>
                    <h5 class="mb-0">À surveiller</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <span>Limite négative atteinte pour Noah</span>
                            <span class="badge bg-danger">-20</span>
                        </li>
                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <span>Révision hebdo de Léa</span>
                            <span class="badge bg-warning text-dark">En cours</span>
                        </li>
                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <span>Nouvelle demande d'accès</span>
                            <span class="badge bg-primary">1</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
